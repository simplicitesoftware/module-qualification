var QualPostTraining=QualPostTraining||(function($){var app,prd,data={list:null,item:null};function render(params,qualTemplate){try{if(typeof Vue==='undefined')throw'Vue.js not available';if(!params.pub)$('#demovuejsfrontend').css('min-height','1000px');app=new Simplicite.Ajax(params.root,'uipublic');let output=[];let exams=params.exams;let tmp;let unknown=false;let generic=params.generic;let exObjRowId="";let usrExObjIds=[];if(""==exams){unknown=true;completed=true;submitted=true;start=new FlowForm.QuestionModel({id:'start',title:"Oups... ",content:"Il semblerait y avoir un problème avec l'affichage de votre questionnaire. Il est possible que votre token soit inexistant ou ait expiré.",type:FlowForm.QuestionType.SectionBreak,required:false,})
output.push(start);}
else{start=new FlowForm.QuestionModel({id:'start',title:"Bonjour "+String.fromCodePoint("0x1F44B"),subtitle:"Vous avez été invité à répondre à un questionnaire.",description:"Lorsque vous êtes prêts, cliquez sur 'suivant' ou Appuyez sur la touche ENTRÉE pour commencer.",type:FlowForm.QuestionType.SectionBreak,required:true,});output.push(start);for(let k=0;k<exams.length;k++){let input=exams[k].questions;let examTitle=exams[k].examTitle;for(let i=0;i<input.length;i++){if(input[i].type=="ENUM"){tmp=createEnumElement(input[i],exams[k]);}
else if(input[i].type=="TXT"){tmp=createTxtElement(input[i],exams[k]);}
else if(input[i].type=="QST_BREAK"){tmp=createBreakElement(exams[k]);}
output.push(tmp);}}}
let languageParams=new FlowForm.LanguageModel({enterKey:'Entrée',shiftKey:'Maj',continue:'Suivant',pressEnter:'Appuyez sur :enterKey',otherPrompt:'Autre',submitText:'Valider',placeholder:'Saisissez votre réponse ici...',percentCompleted:':percent% complété',multipleChoiceHelpTextSingle:'Choisissez une valeur',longTextHelpText:':shiftKey + :enterKey pour aller à la ligne.'})
new Vue({el:'#app',template:qualTemplate,data:function(){return{loading:false,scored:false,submitted:false,completed:false,language:languageParams,questions:output,isValid:!unknown,generic:params.generic,scores:[]}},methods:{onAnswer(qA){let id=qA.id;if(qA.type==FlowForm.QuestionType.SectionBreak&&qA.id.includes("exam")){var usrExObj=app.getBusinessObject("QualUserExam");usrExObj.resetFilters();usrExObj.getForCreate(function(){usrExObj.item.qualUsrexamUsrId=params.userId;usrExObj.item.qualUsrexamExamId=qA.examId;usrExObj.create(function(){exObjRowId=usrExObj.getRowId();usrExObjIds.push(exObjRowId);},usrExObj.item);});}
if(qA.type!==FlowForm.QuestionType.SectionBreak){let submittedValue=qA.answer;var usrAnswerObj=app.getBusinessObject("QualExUsr");usrAnswerObj.resetFilters();usrAnswerObj.search(function(){usrAnswerObj.getForUpdate(function(){usrAnswerObj.item.qualExusrSubmitted=true;usrAnswerObj.item.qualExusrAnswer=submittedValue;usrAnswerObj.update();},usrAnswerObj.list[0].row_id);},{qualExusrUsrexamId:exObjRowId,qualExusrExamexId__qualExamexExId__qualExId:qA.id});}},onComplete(completed,questionList){this.completed=completed
if(this.generic){this.onQuizSubmit();}},onQuizSubmit(){this.$refs.flowform.submitted=true
this.submitted=true
if(!unknown){this.validateExams();exams.forEach(exam=>{examQuestions=[];this.questions.forEach(qst=>{if(qst.examId==exam.examId&&qst.type!==FlowForm.QuestionType.SectionBreak){examQuestions.push(qst);}});if(exam.examTitle!="Retours Formation"){let examScore=this.calculateScore(exam,examQuestions);this.scores.push(examScore);}})
this.scored=true;}},calculateScore(exam,qsts){score=0;total=qsts.length;qsts.forEach(qst=>{let answer=qst.answer;if(answer==exam.answers[qst.id]){score++}});score=Math.round((score/total)*100);return{"examId":exam.examId,"examTitle":exam.examTitle,"score":score};},validateExams(){this.loading=true;var obj=app.getBusinessObject("QualUserExam");obj.resetFilters();usrExObjIds.forEach(id=>{obj.getForUpdate(function(){obj.item.qualUsrexamEtat="DONE";obj.update();},id);});setTimeout(()=>{this.loading=false;},1000)},store(exam,qsts){this.loading=true;setTimeout(()=>{this.loading=false;},1000)},},});}catch(e){console.error('Render error: '+e.message);}
function createEnumElement(input,exam){let choices=[];let iChoices=input.enum.split("@@@");for(let j=0;j<iChoices.length;j++){tmpChoice=new FlowForm.ChoiceOption({label:iChoices[j],}),choices.push(tmpChoice);}
return new FlowForm.QuestionModel({examId:exam.examId,id:input.id,title:input.title,helpTextShow:false,type:FlowForm.QuestionType.MultipleChoice,required:true,multiple:false,options:choices,});}
function createTxtElement(input,exam){return new FlowForm.QuestionModel({examId:exam.examId,id:input.id,title:input.title,type:FlowForm.QuestionType.LongText,required:true});}
function createBreakElement(exam){return new FlowForm.QuestionModel({id:"exam-"+exam.examId+"-break",examId:exam.examId,title:exam.examTitle,description:exam.examDescription,type:FlowForm.QuestionType.SectionBreak,});}}
return{render:render};})(jQuery);